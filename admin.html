<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Ajouter une carte</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="admin-container">
        <h2>Ajouter un souvenir</h2>
        
        <input type="password" id="admin-pass" class="admin-input" placeholder="Mot de passe secret">
        
        <div id="admin-form" style="display:none; flex-direction: column; gap: 15px;">
            <input type="text" id="card-title" class="admin-input" placeholder="Titre (ex: Notre voyage)">
            <textarea id="card-text" class="admin-input" rows="4" placeholder="Description..."></textarea>
            
            <input type="file" id="card-image" class="admin-input" accept="image/*">
            <img id="preview" class="preview-img">
            
            <button id="btn-add" class="admin-btn">Publier</button>
            <div id="status" style="text-align: center; opacity: 0.7;"></div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <!-- Storage removed -->

    <script src="firebase-config.js"></script>
    <script>
        // Init Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();

        // Simple Auth Check
        const passInput = document.getElementById('admin-pass');
        const form = document.getElementById('admin-form');
        
        passInput.addEventListener('keyup', (e) => {
            if (e.target.value === 'benji123') {
                form.style.display = 'flex';
                passInput.style.display = 'none';
            }
        });

        // Image Preview & Compression Logic
        const fileInput = document.getElementById('card-image');
        const preview = document.getElementById('preview');
        let compressedImageBase64 = null;
        
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    // Create an image object to handle resizing
                    const img = new Image();
                    img.onload = function() {
                        // Canvas for compression
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // Max dimensions (limit to 800px width to keep DB size low)
                        const MAX_WIDTH = 800;
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > MAX_WIDTH) {
                            height *= MAX_WIDTH / width;
                            width = MAX_WIDTH;
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Compress to JPEG 70% quality
                        compressedImageBase64 = canvas.toDataURL('image/jpeg', 0.7);
                        
                        // Show preview
                        preview.src = compressedImageBase64;
                        preview.style.display = 'block';
                    }
                    img.src = event.target.result;
                }
                reader.readAsDataURL(file);
            }
        });

        // Upload Logic (Direct to Firestore)
        document.getElementById('btn-add').addEventListener('click', async () => {
            const title = document.getElementById('card-title').value;
            const text = document.getElementById('card-text').value;
            const status = document.getElementById('status');

            if (!title || !compressedImageBase64) {
                alert('Il faut au moins un titre et une image !');
                return;
            }

            status.innerText = 'Envoi en cours...';
            
            try {
                // Get current count to assign ID/Order
                const snapshot = await db.collection('cards').get();
                const count = snapshot.size;

                // Save directly to Firestore (No Storage bucket needed)
                await db.collection('cards').add({
                    id: count + 1,
                    title: title,
                    text: text,
                    image: compressedImageBase64, // Storing the image string directly
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                status.innerText = 'Carte ajoutée avec succès !';
                
                // Reset form
                document.getElementById('card-title').value = '';
                document.getElementById('card-text').value = '';
                fileInput.value = '';
                preview.style.display = 'none';
                compressedImageBase64 = null;
                
            } catch (error) {
                console.error(error);
                status.innerText = 'Erreur: ' + error.message;
            }
        });
    </script>
</body>
</html>
